<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>College Softball Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet (map library) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg-page: #f8f9fb;
      --card-bg: #ffffff;
      --border-subtle: #e4e7f0;
      --text-main: #1a1a1d;
      --text-muted: #6d6d72;
      --accent: #4a8df2;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    /* HERO */

    .hero {
      position: relative;
      min-height: 260px;
      background-image: url('hero-softball.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.55),
        rgba(0, 0, 0, 0.75)
      );
    }

    .hero-content {
      position: relative;
      max-width: 900px;
      padding: 32px 20px 40px;
      color: #ffffff;
    }

   .hero-title {
  margin: 0 0 14px;
  font-size: 36px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.hero-subtitle {
  margin: 0;
  font-size: 16px;
  line-height: 1.65;
  color: #f3f4ff;
}


    /* MAIN LAYOUT */

    main {
      max-width: 1100px;
      margin: 26px auto 80px;
      padding: 0 20px;
    }

    /* FILTERS */

    .filters-card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      padding: 18px 18px 16px;
      margin-bottom: 22px;
    }

    .filters-title {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 12px;
    }

    .filters-section {
      margin-bottom: 12px;
    }

    .filters-row {
      display: grid;
      gap: 10px;
    }

    .filters-row + .filters-row {
      margin-top: 10px;
    }

    .filters-row-1 {
      grid-template-columns: minmax(0, 1fr);
    }

    .filters-row-2 {
      grid-template-columns: 1.2fr 1fr 1fr 1fr;
    }

    .filters-row-3 {
      grid-template-columns: 1fr 1fr auto auto;
      align-items: center;
    }

    input, select {
      padding: 9px 11px;
      border-radius: 8px;
      border: 1px solid #d4d7e2;
      font-size: 13px;
      outline: none;
      background: #ffffff;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(74, 141, 242, 0.2);
    }

    button {
      font-family: inherit;
    }

    .btn {
      padding: 9px 14px;
      border-radius: 8px;
      border: 1px solid #d4d7e2;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }

    .btn-secondary {
      background: #f7f9fc;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .helper-text {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* MAP */

    #map-container {
      display: none;
      margin-bottom: 24px;
    }

    #map {
      height: 360px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    /* TEAMS */

    .results-note {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .team-card {
      background: var(--card-bg);
      padding: 18px 18px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }

    .team-name {
      font-size: 16px;
      font-weight: 600;
    }

    .team-location {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .pill {
      margin-top: 8px;
      font-size: 12px;
      background: #f1f4fa;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }

    .pill-distance {
      margin-left: 6px;
      color: #3b4256;
    }

    .roster-btn {
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d4d7e2;
      background: #f7f9fc;
      cursor: pointer;
    }

    .roster {
      margin-top: 12px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }

    .roster.open {
      max-height: 330px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 6px 4px;
      color: var(--text-muted);
      font-size: 12px;
      border-bottom: 1px solid #e2e4ea;
    }

    td {
      padding: 6px 4px;
      border-bottom: 1px solid #f2f2f4;
    }

    .empty-message {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .teams-grid { grid-template-columns: 1fr 1fr; }
      .filters-row-2 { grid-template-columns: 1fr 1fr; }
      .filters-row-3 { grid-template-columns: 1fr 1fr; row-gap: 8px; }
    }

    @media (max-width: 600px) {
      .teams-grid { grid-template-columns: 1fr; }
      .filters-row-2 { grid-template-columns: 1fr; }
      .filters-row-3 { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>

<!-- HERO HEADER -->
<section class="hero">
  <div class="hero-content">
    <h1 class="hero-title">College Softball Search</h1>
    <p class="hero-subtitle">
      "Finding the right college softball program begins with clarity. Our tool helps parents and players narrow down options by location, conference, competitive level, enrollment size, class breakdown, retention rates, and coaching stability. Instead of feeling lost in endless choices, you’ll have a focused starting point to explore programs that truly match your priorities — making the first step in the recruiting process simpler, smarter, and more confident."
    </p>
  </div>
</section>

<main>
  <!-- FILTERS -->
  <section class="filters-card">
    <h2 class="filters-title">Filter programs</h2>

    <div class="filters-section">
      <div class="filters-row filters-row-1">
        <input id="search" placeholder="Search teams…" />
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-row filters-row-2">
        <input id="zip" placeholder="ZIP (optional)" />
        <select id="radius">
          <option value="0">Any distance</option>
          <option value="50">Within 50 miles</option>
          <option value="100">Within 100 miles</option>
          <option value="200">Within 200 miles</option>
          <option value="400">Within 400 miles</option>
        </select>
        <select id="division">
          <option value="">All divisions</option>
          <option value="D1">Division I</option>
          <option value="D2">Division II</option>
          <option value="D3">Division III</option>
          <option value="NAIA">NAIA</option>
          <option value="JUCO">JUCO</option>
        </select>
        <select id="conference">
          <option value="">All conferences</option>
        </select>
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-row filters-row-3">
        <select id="filter-pos">
          <option value="">All positions</option>
        </select>
        <select id="filter-class">
          <option value="">All classes</option>
        </select>
        <button id="toggle-map" class="btn btn-secondary">Show map</button>
        <button id="search-btn" class="btn btn-primary">Search</button>
      </div>
    </div>

    <div class="helper-text">
      Choose your priorities, then click <strong>Search</strong> to see matching programs.
    </div>
  </section>

  <!-- MAP (hidden until toggled) -->
  <section id="map-container">
    <div id="map"></div>
  </section>

  <!-- RESULTS -->
  <section>
    <p id="results-note" class="results-note">
      No results yet. Set your filters above and click <strong>Search</strong>.
    </p>
    <div id="teams" class="teams-grid"></div>
    <div id="no-results" class="empty-message" style="display:none;">
      No programs match your current filters. Try widening your search.
    </div>
  </section>
</main>

<script>
  let allTeams = [];
  let filtered = [];
  let map;
  let mapMarkers = [];
  let mapInitialized = false;
  let originLatLng = null; // user ZIP origin if available

  // Haversine distance in miles
  function distanceMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => (d * Math.PI) / 180;
    const R = 3958.8; // Earth radius in miles
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // Real ZIP → lat/lng lookup via Zippopotam.us
  async function lookupZipLatLng(zip) {
    const url = `https://api.zippopotam.us/us/${zip}`;
    try {
      const response = await fetch(url);
      if (!response.ok) return null;
      const data = await response.json();
      const place = data.places && data.places[0];
      if (!place) return null;
      return {
        lat: parseFloat(place.latitude),
        lng: parseFloat(place.longitude)
      };
    } catch (err) {
      console.error("ZIP lookup failed:", err);
      return null;
    }
  }

  async function loadData() {
    const res = await fetch("softball_sec.json");
    const data = await res.json();
    allTeams = Array.isArray(data) ? data : [];

    // Enrich teams
    allTeams.forEach(t => {
      t.rosterSize = (t.players || []).length;
      t.distanceMilesFromOrigin = null;
    });

    buildFilterOptions();
  }

  function buildFilterOptions() {
    const posSet = new Set();
    const classSet = new Set();
    const confSet = new Set();

    allTeams.forEach(t => {
      if (t.conf) confSet.add(t.conf);

      (t.players || []).forEach(p => {
        if (p.pos) posSet.add(p.pos);
        if (p.class) classSet.add(p.class);
      });
    });

    const posSelect = document.getElementById("filter-pos");
    posSet.forEach(pos => {
      const o = document.createElement("option");
      o.value = pos;
      o.textContent = pos;
      posSelect.appendChild(o);
    });

    const classSelect = document.getElementById("filter-class");
    classSet.forEach(cls => {
      const o = document.createElement("option");
      o.value = cls;
      o.textContent = cls;
      classSelect.appendChild(o);
    });

    const confSelect = document.getElementById("conference");
    Array.from(confSet)
      .sort()
      .forEach(conf => {
        const o = document.createElement("option");
        o.value = conf;
        o.textContent = conf;
        confSelect.appendChild(o);
      });

    document.getElementById("toggle-map").addEventListener("click", toggleMap);
    document.getElementById("search-btn").addEventListener("click", () => {
      runSearch();
    });
  }

  async function runSearch() {
    // start with all
    filtered = [...allTeams];

    const q = document.getElementById("search").value.toLowerCase().trim();
    const pos = document.getElementById("filter-pos").value;
    const cls = document.getElementById("filter-class").value;
    const division = document.getElementById("division").value;
    const conference = document.getElementById("conference").value;
    const zip = document.getElementById("zip").value.trim();
    const radius = parseFloat(document.getElementById("radius").value || "0");

    // Division filter (placeholder-ready)
    if (division) {
      filtered = filtered.filter(
        t => (t.division || "").toUpperCase() === division.toUpperCase()
      );
    }

    // Conference filter
    if (conference) {
      filtered = filtered.filter(t => (t.conf || "") === conference);
    }

    // Team search (NO player search)
    if (q) {
      filtered = filtered.filter(t => {
        const city = (t.city || "").toLowerCase();
        const state = (t.state || "").toLowerCase();
        const name = (t.school || "").toLowerCase();
        return (
          name.includes(q) ||
          city.includes(q) ||
          state.includes(q)
        );
      });
    }

    // Position filter
    if (pos) {
      filtered = filtered.filter(t =>
        (t.players || []).some(p => p.pos === pos)
      );
    }

    // Class filter
    if (cls) {
      filtered = filtered.filter(t =>
        (t.players || []).some(p => p.class === cls)
      );
    }

    // Reset previous distances
    originLatLng = null;
    allTeams.forEach(t => (t.distanceMilesFromOrigin = null));

    // Location filter (optional)
    if (zip) {
      const origin = await lookupZipLatLng(zip);
      if (!origin) {
        alert("ZIP not recognized yet or lookup failed.");
      } else {
        originLatLng = origin;

        allTeams.forEach(t => {
          if (typeof t.latitude === "number" && typeof t.longitude === "number") {
            t.distanceMilesFromOrigin = distanceMiles(
              origin.lat,
              origin.lng,
              t.latitude,
              t.longitude
            );
          } else {
            t.distanceMilesFromOrigin = null;
          }
        });

        // Reapply radius cutoff if needed
        filtered = filtered.filter(t => {
          if (radius > 0) {
            return (
              t.distanceMilesFromOrigin != null &&
              t.distanceMilesFromOrigin <= radius
            );
          }
          return true;
        });

        // Sort by distance if origin provided
        filtered.sort((a, b) => {
          const da = a.distanceMilesFromOrigin ?? 999999;
          const db = b.distanceMilesFromOrigin ?? 999999;
          return da - db;
        });
      }
    }

    renderTeams();
    if (mapInitialized) updateMapMarkers();

    const note = document.getElementById("results-note");
    if (filtered.length) {
      note.textContent = `Showing ${filtered.length} program(s) that match your filters.`;
    } else {
      note.textContent = "No results yet. Set your filters above and click Search.";
    }
  }

  function renderTeams() {
    const container = document.getElementById("teams");
    const emptyMsg = document.getElementById("no-results");

    container.innerHTML = "";

    if (!filtered.length) {
      emptyMsg.style.display = "block";
      return;
    }
    emptyMsg.style.display = "none";

    filtered.forEach(t => {
      const card = document.createElement("div");
      card.className = "team-card";
      card.id = `team-card-${t.slug || t.school.replace(/\s+/g, "-")}`;

      const loc =
        (t.city || t.state)
          ? `${t.city || ""}${t.city && t.state ? ", " : ""}${t.state || ""}`
          : "";

      const distanceText =
        t.distanceMilesFromOrigin != null
          ? `<span class="pill-distance">${t.distanceMilesFromOrigin.toFixed(0)} miles away</span>`
          : "";

      card.innerHTML = `
        <div class="team-name">${t.school}</div>
        <div class="team-location">${loc}</div>
        <div class="pill">
          ${t.rosterSize} players${distanceText}
        </div>
        <button class="roster-btn">View roster</button>
        <div class="roster">
          ${renderRoster(t.players || [])}
        </div>
      `;

      const btn = card.querySelector(".roster-btn");
      const rosterEl = card.querySelector(".roster");
      btn.addEventListener("click", () => {
        rosterEl.classList.toggle("open");
      });

      container.appendChild(card);
    });
  }

  function renderRoster(players) {
    if (!players.length) {
      return "<div style='font-size:12px; color:#6d6d72;'>No roster data yet.</div>";
    }

    const rows = players
      .map(
        p => `<tr>
                <td>${p.number || ""}</td>
                <td>${p.name}</td>
                <td>${p.pos}</td>
                <td>${p.class}</td>
              </tr>`
      )
      .join("");

    return `
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Pos</th><th>Class</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // MAP

  function toggleMap() {
    const container = document.getElementById("map-container");
    const btn = document.getElementById("toggle-map");

    if (container.style.display === "none" || container.style.display === "") {
      container.style.display = "block";
      btn.textContent = "Hide map";
      if (!mapInitialized) initMap();
      updateMapMarkers();
    } else {
      container.style.display = "none";
      btn.textContent = "Show map";
    }
  }

  function initMap() {
    const defaultCenter = [34.0, -88.0]; // rough SE US
    map = L.map("map").setView(defaultCenter, 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    mapInitialized = true;
  }

  function updateMapMarkers() {
    if (!mapInitialized) return;

    mapMarkers.forEach(m => map.removeLayer(m));
    mapMarkers = [];

    if (!filtered.length) return;

    const bounds = [];

    filtered.forEach(t => {
      if (typeof t.latitude !== "number" || typeof t.longitude !== "number") return;

      const marker = L.marker([t.latitude, t.longitude]).addTo(map);
      marker.bindPopup(`<strong>${t.school}</strong><br>${t.city || ""}, ${t.state || ""}`);

      marker.on("click", () => {
        const cardId = `team-card-${t.slug || t.school.replace(/\s+/g, "-")}`;
        const el = document.getElementById(cardId);
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "start" });
          el.style.outline = "2px solid #4a8df2";
          setTimeout(() => (el.style.outline = "none"), 1500);
        }
      });

      mapMarkers.push(marker);
      bounds.push([t.latitude, t.longitude]);
    });

    if (bounds.length) {
      map.fitBounds(bounds, { padding: [30, 30] });
    } else if (originLatLng) {
      map.setView([originLatLng.lat, originLatLng.lng], 6);
    }
  }

  loadData();
</script>

</body>
</html>
