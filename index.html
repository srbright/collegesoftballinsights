<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>College Softball Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg-page: #f8f9fb;
      --card-bg: #ffffff;
      --border-subtle: #e4e7f0;
      --text-main: #1a1a1d;
      --text-muted: #6d6d72;
      --accent: #4a8df2;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    /* HERO */

    .hero {
      position: relative;
      min-height: 280px;
      background-image: url('hero-softball.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.55),
        rgba(0, 0, 0, 0.75)
      );
    }

    .hero-content {
      position: relative;
      max-width: 900px;
      padding: 36px 20px 40px;
      color: #ffffff;
    }

    .hero-title {
      margin: 0 0 16px;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .hero-subtitle {
      margin: 0;
      font-size: 16px;
      line-height: 1.65;
      color: #f3f4ff;
    }

    main {
      max-width: 1100px;
      margin: 30px auto 80px;
      padding: 0 20px;
    }

    /* FILTER CARD */

    .filters-card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      padding: 20px;
      margin-bottom: 26px;
    }

    .filters-title {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 14px;
    }

    .filters-section { margin-bottom: 14px; }

    .filters-row {
      display: grid;
      gap: 10px;
    }

    .row-1 { grid-template-columns: 1fr; }
    .row-2a { grid-template-columns: 1fr 1fr; }
    .row-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    input, select {
      padding: 9px 11px;
      border-radius: 8px;
      border: 1px solid #d4d7e2;
      font-size: 13px;
      background: #ffffff;
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(74,141,242,0.2);
    }

    .btn {
      padding: 9px 14px;
      border-radius: 8px;
      border: 1px solid #d4d7e2;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }
    .btn-secondary {
      background: #f7f9fc;
    }

    .helper-text {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* MAP */

    #map-container {
      display: none;
      margin-bottom: 24px;
    }

    #map {
      height: 360px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    /* RESULTS */

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .team-card {
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .team-name { font-size: 16px; font-weight: 600; }
    .team-location { font-size: 13px; color: var(--text-muted); }

    .pill {
      margin-top: 8px;
      font-size: 12px;
      background: #f1f4fa;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }

    .pill-distance { margin-left: 6px; color: #3b4256; }

    .roster-btn {
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d4d7e2;
      background: #f7f9fc;
      cursor: pointer;
    }

    .roster {
      margin-top: 12px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }
    .roster.open { max-height: 330px; }

    @media (max-width: 900px) {
      .teams-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .teams-grid { grid-template-columns: 1fr; }
      .row-buttons { justify-content: start; }
    }
  </style>
</head>

<body>

<section class="hero">
  <div class="hero-content">
    <h1 class="hero-title">College Softball Search</h1>
    <p class="hero-subtitle">
      "Finding the right college softball program begins with clarity. Our tool helps parents and players narrow down options by location, conference, competitive level, enrollment size, class breakdown, retention rates, and coaching stability. Instead of feeling lost in endless choices, you’ll have a focused starting point to explore programs that truly match your priorities — making the first step in the recruiting process simpler, smarter, and more confident."
    </p>
  </div>
</section>

<main>

  <section class="filters-card">
    <h2 class="filters-title">Filter programs</h2>

    <div class="filters-section">
      <div class="filters-row row-1">
        <input id="search" placeholder="Search teams…" />
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-row row-2a">
        <select id="division">
          <option value="">All divisions</option>
          <option value="D1">Division I</option>
          <option value="D2">Division II</option>
          <option value="D3">Division III</option>
          <option value="NAIA">NAIA</option>
          <option value="JUCO">JUCO</option>
        </select>

        <select id="conference">
          <option value="">All conferences</option>
        </select>
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-row row-2a">
        <input id="zip" placeholder="ZIP (optional)" />
        <select id="radius">
          <option value="0">Any distance</option>
          <option value="50">Within 50 miles</option>
          <option value="100">Within 100 miles</option>
          <option value="200">Within 200 miles</option>
          <option value="400">Within 400 miles</option>
        </select>
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-row row-buttons">
        <button id="toggle-map" class="btn btn-secondary">Show map</button>
        <button id="reset-filters" class="btn btn-secondary">Reset</button>
        <button id="search-btn" class="btn btn-primary">Search</button>
      </div>
    </div>

    <div class="helper-text">
      Choose your priorities, then click <strong>Search</strong>.
    </div>
  </section>

  <section id="map-container">
    <div id="map"></div>
  </section>

  <section>
    <p id="results-note" class="results-note">
      No results yet. Set your filters and click Search.
    </p>
    <div id="teams" class="teams-grid"></div>
    <div id="no-results" class="empty-message" style="display: none;">
      No programs match your filters.
    </div>
  </section>

</main>

<script>
  let allTeams = [];
  let filtered = [];
  let map;
  let mapMarkers = [];
  let mapInitialized = false;
  let originLatLng = null;

  function distanceMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => (d * Math.PI) / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2)**2 +
      Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  async function lookupZipLatLng(zip) {
    const url = `https://api.zippopotam.us/us/${zip}`;
    try {
      const response = await fetch(url);
      if (!response.ok) return null;

      const data = await response.json();
      const place = data.places?.[0];
      return place
        ? { lat: parseFloat(place.latitude), lng: parseFloat(place.longitude) }
        : null;
    } catch {
      return null;
    }
  }

  async function loadData() {
    const res = await fetch("all_teams.json");
    const data = await res.json();

    allTeams = Array.isArray(data) ? data : [];
    allTeams.forEach(t => {
      t.rosterSize = (t.players || []).length;
      t.distanceMilesFromOrigin = null;
    });

    buildConferenceOptions();
    document.getElementById("toggle-map").addEventListener("click", toggleMap);
    document.getElementById("search-btn").addEventListener("click", runSearch);
    document.getElementById("reset-filters").addEventListener("click", resetFilters);
  }

  function buildConferenceOptions() {
    const confSelect = document.getElementById("conference");
    const confSet = new Set();

    allTeams.forEach(t => {
      if (t.conf) confSet.add(t.conf);
    });

    confSet.forEach(conf => {
      const o = document.createElement("option");
      o.value = conf;
      o.textContent = conf;
      confSelect.appendChild(o);
    });
  }

  function resetFilters() {
    document.getElementById("search").value = "";
    document.getElementById("zip").value = "";
    document.getElementById("radius").value = "0";
    document.getElementById("division").value = "";
    document.getElementById("conference").value = "";

    filtered = [];
    document.getElementById("teams").innerHTML = "";
    document.getElementById("no-results").style.display = "none";
    document.getElementById("results-note").textContent =
      "No results yet. Set your filters and click Search.";

    originLatLng = null;
    if (mapInitialized) updateMapMarkers();
  }

  async function runSearch() {
    filtered = [...allTeams];

    const q = document.getElementById("search").value.toLowerCase().trim();
    const division = document.getElementById("division").value;
    const conference = document.getElementById("conference").value;
    const zip = document.getElementById("zip").value.trim();
    const radius = parseFloat(document.getElementById("radius").value || "0");

    if (division) {
      filtered = filtered.filter(t => (t.division || "") === division);
    }

    if (conference) {
      filtered = filtered.filter(t => t.conf === conference);
    }

    if (q) {
      filtered = filtered.filter(t =>
        t.school.toLowerCase().includes(q) ||
        (t.city || "").toLowerCase().includes(q) ||
        (t.state || "").toLowerCase().includes(q)
      );
    }

    originLatLng = null;
    allTeams.forEach(t => (t.distanceMilesFromOrigin = null));

    if (zip) {
      const origin = await lookupZipLatLng(zip);
      if (origin) {
        originLatLng = origin;

        allTeams.forEach(t => {
          if (t.latitude && t.longitude) {
            t.distanceMilesFromOrigin = distanceMiles(
              origin.lat,
              origin.lng,
              t.latitude,
              t.longitude
            );
          }
        });

        if (radius > 0) {
          filtered = filtered.filter(
            t =>
              t.distanceMilesFromOrigin != null &&
              t.distanceMilesFromOrigin <= radius
          );
        }

        filtered.sort((a, b) =>
          (a.distanceMilesFromOrigin ?? 999999) -
          (b.distanceMilesFromOrigin ?? 999999)
        );
      } else {
        alert("ZIP not found.");
      }
    }

    renderTeams();
    if (mapInitialized) updateMapMarkers();

    document.getElementById("results-note").textContent =
      filtered.length
        ? `Showing ${filtered.length} program(s).`
        : "No results yet. Set your filters and click Search.";
  }

  function renderTeams() {
    const container = document.getElementById("teams");
    const emptyMsg = document.getElementById("no-results");
    container.innerHTML = "";

    if (!filtered.length) {
      emptyMsg.style.display = "block";
      return;
    }

    emptyMsg.style.display = "none";

    filtered.forEach(t => {
      const card = document.createElement("div");
      card.className = "team-card";

      const loc = `${t.city}, ${t.state}`;
      const dist = t.distanceMilesFromOrigin != null
        ? `<span class="pill-distance">${t.distanceMilesFromOrigin.toFixed(0)} miles</span>`
        : "";

      card.innerHTML = `
        <div class="team-name">${t.school}</div>
        <div class="team-location">${loc}</div>
        <div class="pill">${t.rosterSize} players ${dist}</div>
        <button class="roster-btn">View roster</button>
        <div class="roster">${renderRoster(t.players || [])}</div>
      `;

      const btn = card.querySelector(".roster-btn");
      const rosterEl = card.querySelector(".roster");
      btn.addEventListener("click", () => {
        rosterEl.classList.toggle("open");
      });

      container.appendChild(card);
    });
  }

  function renderRoster(players) {
    if (!players.length) {
      return "<div style='font-size:12px;color:#666;'>No roster data.</div>";
    }

    return `
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Pos</th><th>Class</th></tr>
        </thead>
        <tbody>
          ${players
            .map(
              p => `
            <tr>
              <td>${p.number || ""}</td>
              <td>${p.name}</td>
              <td>${p.pos}</td>
              <td>${p.class}</td>
            </tr>`
            )
            .join("")}
        </tbody>
      </table>
    `;
  }

  function toggleMap() {
    const container = document.getElementById("map-container");
    const btn = document.getElementById("toggle-map");

    if (container.style.display === "none") {
      container.style.display = "block";
      btn.textContent = "Hide map";

      if (!mapInitialized) initMap();
      updateMapMarkers();
    } else {
      container.style.display = "none";
      btn.textContent = "Show map";
    }
  }

  function initMap() {
    map = L.map("map").setView([34.0, -88.0], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    mapInitialized = true;
  }

  function updateMapMarkers() {
    if (!mapInitialized) return;

    mapMarkers.forEach(m => map.removeLayer(m));
    mapMarkers = [];

    const bounds = [];

    filtered.forEach(t => {
      if (t.latitude && t.longitude) {
        const marker = L.marker([t.latitude, t.longitude]).addTo(map);
        marker.bindPopup(`<strong>${t.school}</strong><br>${t.city}, ${t.state}`);

        marker.on("click", () => {
          document
            .getElementById("teams")
            .querySelector(`.team-card:nth-child(${filtered.indexOf(t) + 1})`)
            ?.scrollIntoView({ behavior: "smooth" });
        });

        mapMarkers.push(marker);
        bounds.push([t.latitude, t.longitude]);
      }
    });

    if (bounds.length) {
      map.fitBounds(bounds, { padding: [30, 30] });
    }
  }

  loadData();
</script>

</body>
</html>
